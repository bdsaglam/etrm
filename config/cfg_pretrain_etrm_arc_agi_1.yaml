# Encoder-based TRM training config - ORIGINAL TRAINING MODE
#
# Uses ORIGINAL TRM training dynamics:
# - ONE forward per batch (carry persists across batches)
# - Dynamic halting with Q-head exploration during training
# - Encoder called once when sample starts (cached in carry)
#
# This matches the original TRM paper's training approach.

defaults:
  - arch: etrm
  - _self_

hydra:
  output_subdir: null

# Override arch values
arch:
  L_layers: 2
  H_cycles: 3
  L_cycles: 6  # Default: more capacity. IMPORTANT: Use L_cycles: 4 when load_pretrained_decoder is set!

# Data path - use encoder-mode preprocessed data
data_paths: ["data/arc1concept-encoder-aug-1000"]
data_paths_test: []
max_train_groups: null
max_eval_groups: null

evaluators:
  - name: arc@ARC

# Prediction visualization logging
log_predictions_every: 5000
log_predictions_max_samples: 32  # Max samples per log
log_predictions_crop: True  # If true, crop to content; if false, show full 30x30

# Hyperparams - Training
global_batch_size: 384  # Reduced from TRM's 768 due to encoder memory overhead
max_demos: 10  # Maximum demos per batch item

epochs: 100000
eval_interval: 10000
checkpoint_every_eval: True

lr: 1e-4
lr_min_ratio: 1.0
lr_warmup_steps: 2000

# Standard hyperparameter settings for LM
beta1: 0.9
beta2: 0.95
weight_decay: 0.1

# Gradient clipping (0 = disabled)
# Note: 1.0 significantly improves training stability (96.7% vs 85.4% on overfit test)
grad_clip_norm: 1.0

# Separate encoder learning rate (multiplier)
# 0 = disabled (single optimizer), 0.1 = encoder 10x slower
encoder_lr_scale: 0.0

# Transfer learning: load pretrained TRM decoder weights
# null = disabled, path = load from checkpoint (skips puzzle_emb)
load_pretrained_decoder: null

# Staged training: freeze decoder for first N steps (train encoder only)
# 0 = disabled (train full model from start)
freeze_decoder_steps: 0

# NO puzzle_emb_lr - single optimizer for encoder mode

seed: 0
min_eval_interval: 0

ema: True
ema_rate: 0.999

# Not used in encoder mode, kept for compatibility
freeze_weights: False
